name: Ansible Config

run-name: Ansible Config Pipeline on ${{ inputs.Env }}

on:
  workflow_dispatch:
    inputs:
      Env:
        type: choice
        description: 'Environment'
        required: true
        options:
          - T1
          - PRD
      AvailabilityZone:
        type: choice
        description: 'Availability Zone'
        required: true
        options:
            - blue
            - red

jobs:
    ansible:
        runs-on: ubuntu-latest
        environment: ${{ inputs.Env }}
        steps:
          - uses: actions/checkout@v4

          - name: Set up ssh key
            run: |
                mkdir -p ~/.ssh/
                echo ${{ secrets.AWS_SSH_KEY }} | base64 --decode > ~/.ssh/ansible_key
                chmod 600 ~/.ssh/ansible_key
                chmod 700 ~/.ssh

          - uses: qetza/replacetokens-action@v1
            with:
              sources: 'ansible/inventory/envs/${{ inputs.Env }}/hosts.yml; ansible/infra.yml'
              variables: '[${{ toJson(secrets)}}, ${{ toJson(inputs)}}]'
              token-prefix: '#{'
              token-suffix: '}#'

          - name: Ansible Playbook
            working-directory: ./ansible
            run: |
                ansible-playbook -v -i inventory/envs/${{ inputs.Env }}/hosts.yml --private-key ~/.ssh/ansible_key infra.yml
